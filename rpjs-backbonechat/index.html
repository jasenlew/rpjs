<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>

	<script>

		var appleData = [
			{
				name: "fuji",
				url: "img/fuji.jpeg"
			},
			{
				name: "gala",
				url: "img/gala.jpeg"
			}
		];

		var app;

		var router = Backbone.Router.extend({
			routes: {
				'': 'home',
				'apples/:appleName': 'loadApple'
			},

			initialize: function () {
				var apples = new Apples();
				apples.reset(appleData);
				console.log(apples);
				this.homeView = new homeView({collection: apples});
				this.appleView = new appleView({collection: apples});
			},

			home : function () {
				this.homeView.render();
			},

			loadApple: function (appleName) {
				this.appleView.loadApple(appleName);
			}
		});

		var homeView = Backbone.View.extend({
			el: 'body',
			listEl: '.apples-list',
			cartEl: '.cart-box',
			template: _.template('Apple data: \
				<ul class="apples-list">\
				</ul>\
				<div class="cart-box"></div>'),

			initialize: function () {
				this.$el.html(this.template);
				this.collection.on('addToCart', this.showCart, this);
			},

			showCart: function (appleModel) {
				$(this.cartEl).append(appleModel.attributes.name + '<br/>');
			},

			render: function () {
				that = this;
				this.collection.each(function (apple) {
					var appleSubView = new appleItemView({model: apple});
					appleSubView.render();
					$(that.listEl).append(appleSubView.$el);
				});
			}
		});

		var Apples = Backbone.Collection.extend({

		});

		var appleView = Backbone.View.extend({

			initialize: function () {
				this.model = new (Backbone.Model.extend({}));
				this.model.bind('change', this.render, this);
				this.on('spinner', this.showSpinner, this);
			},

			template: _.template('<figure>'
				+ '<img src="<%= attributes.url %>" />'
				+ '<figcaption><%= attributes.name %>'
				+ '</figcaption></figure>'
				),

			templateSpinner: '<img src="img/spinner.gif" width="30"/>',

			loadApple: function(appleName) {
				this.trigger('spinner');
				var that = this;
				setTimeout(function () {
					that.model.set(that.collection.where({
						name: appleName
					})[0].attributes);
				}, 1000);
			},

			render: function (appleName) {
				var appleHtml = this.template(this.model);
				$("body").html(appleHtml);
			},

			showSpinner: function () {
				$('body').html(this.templateSpinner);
			}
		});

		var appleItemView = Backbone.View.extend({
			tagname: 'li',
			template: _.template(''
				+ '<a href="#apples/<%= name %>" target="_blank">'
				+ '<%= name %>'
				+ '</a>&nbsp;<a class="add-to-cart" href="#">Buy</a>'),
			events: {
				'click .add-to-cart': 'addToCart'
			},
			render: function () {
				this.$el.html(this.template(this.model.attributes));
			},
			addToCart: function () {
				this.model.collection.trigger('addToCart', this.model);
			}
		});

		$(document).ready(function () {
			app = new router;
			Backbone.history.start();
		});


	</script>

</head>
<body>
	
</body>
</html>